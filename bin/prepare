#!/bin/bash

# fail fast
set -o errexit
set -o nounset
set -o pipefail

indent() {
  sed -u 's/^/       /'
}

scriptname=$(basename $0)
case $# in
  1) :;;
  *) echo "$scriptname: usage: $scriptname BUILD_DIR" >&2; exit 2;;
esac

build_dir="$1"
vendor_rpm_url=http://s3.amazonaws.com/cb-misc/el5-amd64/vendor-rpm-4.11.2.tar.gz
rpmspec=$build_dir/.heroku/vendor/bin/rpmspec
spec_dir=$build_dir/.root

# Basic build dependencies
cat <<EOT
packages:
  - autoconf
  - automake
  - bison
  - byacc
  - elfutils
  - flex
  - gcc
  - gcc-c++
  - gettext
  - libtool
  - make
  - patch
  - patchutils
  - pkgconfig
  - redhat-rpm-config
  - rpm-build
  - tar
  - unzip
  - wget
EOT

mkdir -p "$build_dir"/.heroku
curl -fsSL $vendor_rpm_url | tar -C "$build_dir"/.heroku -xzf -

if [ -f /etc/redhat-release ]
then
  case $(awk '{print $3}' < /etc/redhat-release) in
    5.*)
      cp $(dirname $0)/../vendor/redhat-rpm-config-8.0.45/usr/lib/rpm/redhat/macros ~/.rpmmacros
      cat <<EOT >>$HOME/.rpmmacros
%centos_version 505
%dist .el5
%rhel 5
EOT
      ;;
    6.*)
      cp $(dirname $0)/../vendor/redhat-rpm-config-9.0.3/usr/lib/rpm/redhat/macros ~/.rpmmacros
      cat <<EOT >>$HOME/.rpmmacros
%centos_version 600
%dist .el6
%rhel 6
EOT
      ;;
  esac
fi

if ls $spec_dir/*.spec >/dev/null 2>&1
then
  specfile=$(ls $spec_dir/*.spec)
elif ls $spec_dir/*.spec.in >/dev/null 2>&1
then
  specfile_in=$(echo $spec_dir/*.spec.in)
  specfile=$(echo $specfile_in | sed 's/\.in$//')
  parse_configure_ac=$(dirname $0)/parse-configure-ac
  expand_specfile_in=$(dirname $0)/expand-specfile-in

  package_name=$($parse_configure_ac name < $build_dir/configure.ac)
  package_version=$($parse_configure_ac version < $build_dir/configure.ac)

  $expand_specfile_in $package_name $package_version < $specfile_in > $specfile
fi

$rpmspec -q --buildrequires $specfile > /tmp/packages
error=0
while read -r dep
do
  pkg=$(yum -q resolvedep "$dep")
  case "$pkg" in
    'No Package Found'*)
      echo $pkg >&2
      error=1
      ;;
    *)
      echo "  - $pkg"
      ;;
  esac
done < /tmp/packages
exit $error
